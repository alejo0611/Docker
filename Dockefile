FROM ubuntu:20.04
LABEL maintainer="Axon Ivy AG <info@axonivy.com>"

ARG IVY_ENGINE_DOWNLOAD_URL
ARG IVY_HOME=/usr/lib/axonivy-engine

# Set environment variable to prevent prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Ensure apt-utils is installed
RUN apt-get update && \
    apt-get install -y apt-utils wget unzip && \
    rm -rf /var/lib/apt/lists/*

# Create the IVY_HOME directory and set permissions
RUN mkdir -p ${IVY_HOME} && \
    useradd --uid 1000 --user-group --no-create-home ivy

# Download and unzip the Ivy Engine
RUN wget ${IVY_ENGINE_DOWNLOAD_URL} -O /tmp/ivy.zip --no-verbose && \
    unzip /tmp/ivy.zip -d ${IVY_HOME} && \
    rm -f /tmp/ivy.zip

# Set up directory structure and permissions
RUN mkdir -p ${IVY_HOME}/applications && \
    mkdir -p ${IVY_HOME}/configuration/applications && \
    chown -R ivy:0 ${IVY_HOME} && \
    mkdir -p /var/lib/axonivy-engine && \
    ln -s ${IVY_HOME}/applications /var/lib/axonivy-engine/applications && \
    ln -s ${IVY_HOME}/deploy /var/lib/axonivy-engine/deploy && \
    chown -R ivy:0 /var/lib/axonivy-engine && \
    ln -s ${IVY_HOME}/configuration /etc/axonivy-engine && \
    ln -s ${IVY_HOME}/elasticsearch/config /etc/axonivy-engine/elasticsearch && \
    ln -s ${IVY_HOME}/logs /var/log/axonivy-engine && \
    chmod -R g=u ${IVY_HOME}

WORKDIR ${IVY_HOME}
USER ivy
EXPOSE 8080
HEALTHCHECK --interval=30s --timeout=30s --start-period=5m --retries=3 CMD curl -f http://localhost:8080/ || exit 1
ENTRYPOINT ["/usr/lib/axonivy-engine/bin/AxonIvyEngine"]
